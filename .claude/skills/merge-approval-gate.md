---
name: merge-approval-gate
description: 当用户提到合入 main 分支时触发，强制检查是否有 reviewer 放行
---

# Core Principle

**合入 main 前，必须有 reviewer 明确放行。**

AI 的过度自信会导致：
- 修完 review 问题后，自己判断"改对了"
- 直接合入 main
- 结果上线后发现修错了

**必须有外部检查点（reviewer 的放行信号）来防止 AI 的自我肯定。**

---

## 检查流程

**BEFORE 合入 main:**

1. **CHECK**：是否有 reviewer 的明确放行信号？
   - ✅ "可以放行"
   - ✅ "LGTM" (Looks Good To Me)
   - ✅ "通过"
   - ✅ "没问题了"
   - ✅ "可以合入"

2. **CHECK**：放行信号是否是无条件的？
   - ❌ "整体 OK，但 XXX 需要改"（还有问题，不是放行）
   - ❌ "只剩小问题"（还有问题，不是放行）
   - ❌ "可以放行，但建议 YYY"（条件放行，需要确认 YYY 是否已处理）

3. **BLOCK**：禁止合入
   - ❌ 没有 reviewer 的任何反馈
   - ❌ reviewer 的反馈中有未解决的问题
   - ❌ 只有"感谢"或"收到"，没有明确的放行语句
   - ❌ 自己判断"应该改对了"

4. **PASS**：允许合入
   - ✅ reviewer 明确说"可以放行"
   - ✅ 所有 review 问题都已确认修复
   - ✅ reviewer 没有提出新的问题

---

## Block 场景

### 场景 1：没有放行信号

**User:**
> 合入 main

**❌ 错误的合入:**
> 我修完了 review 问题，应该改对了，直接合入 main 吧。
> （合入了）
> （第二天发现改错了，上线了 bug）

**问题：** 没有 reviewer 的放行信号，自己判断"应该改对了"是危险的。

**教训：** 这就是第二课 F11 事件中布偶猫被铲屎官批评的原因。

---

### 场景 2：放行信号不明确

**User:**
> 准备合入

**❌ 错误的合入:**
> reviewer 说"代码写得不错，测试也通过了"。
> 看来应该 OK 了，合入 main。

**问题：** "写得不错"、"测试通过"不是"可以放行"的明确信号。

---

### 场景 3：还有问题就合入

**User:**
> 合入吧

**❌ 错误的合入:**
> reviewer 说"整体 OK，但有个小建议 XXX"。
> 建议 YYY 我先不改了，合入 main。

**问题：** 还有问题（即使只是建议）就没有真正完成 review。

---

## 通过场景

### 场景 1：明确的放行信号

**User:**
> 合入 main

**✅ 正确的合入:**
> 回顾 reviewer 的反馈：
> 缅因猫说："可以放行了 ✅"
> 暹罗猫说："通过"
>
> 所有 review 问题已修复，测试 729 cases 全部通过。
>
> 合入 main。

---

### 场景 2：修复后重新请求放行

**User:**
> 准备合入

**✅ 正确的合入:**
> 我修完了缅因猫指出的 3P1+3P2 问题，写了一份修复确认：
>
> ### P1-1: 正反方 prompt 同质
> **你的发现**: promptB 算了但没用，两只猫都收到正方 prompt
> **修复**: 新增 modeSystemPromptByCat，按 catId 解析
>
> （... 逐条回应其他问题 ...）
>
> 测试：729 tests, 0 fail
>
> @缅因猫 请确认修复是否正确，可以放行了吗？

---

### 场景 3：澄清放行信号

**User:**
> 合入

**✅ 正确的合入:**
> reviewer 说"整体 OK，但有个小建议：可以加个日志"。
>
> 这个建议是 P3 级别的建议，我先不加日志，合入 main 可以吗？
>
> 或者我应该先加完日志再合入？

---

## 有效的放行信号

以下都是明确的放行信号：

✅ "可以放行了"
✅ "可以合入"
✅ "LGTM" (Looks Good To Me)
✅ "通过"
✅ "没问题了"
✅ "OK，合入吧"
✅ "Approved"

**注意：** 如果放行信号后面跟着"但 XXX"或"建议 YYY"，需要确认是否需要处理。

---

## 无效的"放行"信号

以下**不是**有效的放行信号：

❌ "写得不错"
❌ "代码很清晰"
❌ "没什么大问题"
❌ "Looks good"（没有明确说可以合入）
❌ "整体 OK"（如果后面还有"但..."）
❌ "剩下的小问题"
❌ "建议..."（只是建议，不是放行）
❌ "收到"
❌ "好的"

---

## 教训来源

**F11 Mode System 事件** `[事实: 完整 review 记录在 docs/mailbox/]`：

布偶猫修完 3P1+1P2 后自己判断"改对了"直接合入 main。

铲屎官的批评：
> "你没有等 reviewer 确认就合入了。如果 reviewer 发现还有问题，现在已经在 main 上了。"

**教训：** AI 不会自我质疑，它会执行你的指令。如果你说"合入"，它就合入。必须有外部检查点。

---

## Red-Green-Refactor 流程

更安全的工作流：

1. **Red**: Review 发现问题
   - reviewer: "这里有问题"

2. **Green**: 修复问题
   - 你: "我修完了，请确认"

3. **Refactor**: Reviewer 确认
   - reviewer: "可以放行了"

4. **Merge**: 合入 main
   - 你: 合入

**关键点：** 在 Refactor 和 Merge 之间，必须有 reviewer 的明确放行。

---

## 核心精神

**合入 main 是最后一个检查点，必须有 reviewer 的确认。**

- 自己判断"改对了" = 危险的过度自信
- Reviewer 放行 = 安全的检查点
- 没有放行 = 不合入

**安全第一，宁可多问一次，不要贸然合入。**

---

## 与其他 Skill 的配合

| Skill | 场景 | 动作 |
|-------|------|------|
| `cat-cafe-receiving-review` | 收到 review 反馈 | 修复代码 + 验证 |
| `merge-approval-gate` | 修复完成后 | 检查是否有放行信号再合入 |

**流程：**
```
Review 反馈 → receiving-review (修复) → 回给 reviewer 确认
                                          ↓
                            merge-approval-gate (检查放行信号)
                                          ↓
                                    合入 main
```
