# 02-cli-engineering - CLI å·¥ç¨‹åŒ–å®æˆ˜

> åŸºäºç¬¬äºŒè¯¾ã€Šä»ç©å…·åˆ°ç”Ÿäº§ã€‹çš„ CLI è°ƒç”¨ä»£ç å·¥ç¨‹åŒ–å®è·µ
>
> **åˆ›å»ºæ—¥æœŸ**: 2026-02-20
> **ç‰ˆæœ¬**: v2.0

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯å¯¹ `minimal-claude.js` çš„å·¥ç¨‹åŒ–æ”¹è¿›ç‰ˆæœ¬ï¼Œè§£å†³äº†ä»"ç©å…·ä»£ç "åˆ°"ç”Ÿäº§å¯ç”¨"ä¹‹é—´çš„å…³é”®é—®é¢˜ã€‚

### æ ¸å¿ƒæ”¹è¿›

| ä¼˜å…ˆçº§ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| **P0** | è¶…æ—¶æ£€æµ‹ç¼ºå¤± | åŒæ—¶ç›‘å¬ stdout å’Œ stderr |
| **P0** | stderr æœªå‚ä¸è¶…æ—¶ | å°† stderr ä¹Ÿè§†ä¸ºæ´»è·ƒä¿¡å· |
| **P0** | è¶…æ—¶æ—¶é—´ç¡¬ç¼–ç  | é€šè¿‡ç¯å¢ƒå˜é‡ `CLAUDE_TIMEOUT_MS` é…ç½® |
| **P1** | è¿›ç¨‹ä¿¡å·å¤„ç†ç¼ºå¤± | å®ç° SIGTERM/SIGINT ä¸¤é˜¶æ®µä¼˜é›…å…³æœº |
| **P2** | é‡è¯•æœºåˆ¶ç¼ºå¤± | æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ |
| **P2** | ç¯å¢ƒéš”ç¦»ç¼ºå¤± | æ£€æµ‹è¯¯è¿ç”Ÿäº§ç¯å¢ƒå¹¶è­¦å‘Š |

---

## ğŸ•³ï¸ è¸©è¿‡çš„å‘

### å‘ 1: è¶…æ—¶å®šæ—¶å™¨æœªæ¸…é™¤

**ç°è±¡**:
```
âœ… Execution completed successfully

âš ï¸  Process timeout after 600000ms (last activity: 600003ms ago)

ğŸ›‘ Shutting down...
ğŸ“¤ Sending SIGTERM to child process...
ğŸ’¥ Force killing child process...
```

ä»»åŠ¡å·²ç»æˆåŠŸå®Œæˆï¼Œä½† 10 åˆ†é’Ÿåè¿˜æ˜¯è§¦å‘äº†è¶…æ—¶å…³æœºã€‚

**åŸå› **:
åœ¨ `result.success` äº‹ä»¶ä¸­ resolve äº† Promiseï¼Œä½†è¶…æ—¶å®šæ—¶å™¨æ²¡æœ‰è¢«æ¸…é™¤ï¼Œ10 åˆ†é’Ÿåä»ç„¶è§¦å‘ã€‚

**ä¿®å¤**:
```javascript
case 'result':
  if (event.subtype === 'success') {
    console.log('\n  [Done]');
    saveSession(sid);

    // âœ… æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
    if (timeoutTimer) {
      clearTimeout(timeoutTimer);
      timeoutTimer = null;
    }

    resolve();
  }
```

**æ•™è®­**:
- Promise resolve/reject æ—¶å¿…é¡»æ¸…ç†æ‰€æœ‰å¼‚æ­¥èµ„æºï¼ˆå®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨ç­‰ï¼‰
- åœ¨å¤šä¸ªåœ°æ–¹è®¾ç½®å®šæ—¶å™¨æ—¶ï¼Œè¦ç¡®ä¿æ¯ä¸ªé€€å‡ºè·¯å¾„éƒ½æœ‰æ¸…é™¤é€»è¾‘

---

### å‘ 2: åªç›‘å¬ stdout ä¼šå¯¼è‡´è¯¯åˆ¤è¶…æ—¶

**ç°è±¡**:
CLI è¿›ç¨‹åœ¨è®¤çœŸæ€è€ƒï¼ˆthinkingï¼‰å’Œè°ƒç”¨å·¥å…·æ—¶ï¼Œstdout æ²¡æœ‰è¾“å‡ºï¼Œä½†ç¨‹åºåˆ¤å®šä¸º"å¡æ­»"ï¼Œç›´æ¥ SIGKILLã€‚

**åŸå› **:
CLI åœ¨ thinking å’Œå·¥å…·è°ƒç”¨æ—¶è¾“å‡ºåˆ° **stderr**ï¼Œä¸æ˜¯ stdoutã€‚ä½†ä»£ç åªç›‘å¬ stdout åˆ·æ–°è¶…æ—¶ã€‚

**ä¿®å¤**:
```javascript
// âŒ é”™è¯¯ï¼šåªç›‘å¬ stdout
claude.stdout.on('data', refreshTimeout);

// âœ… æ­£ç¡®ï¼šåŒæ—¶ç›‘å¬ stdout å’Œ stderr
claude.stdout.on('data', refreshTimeout);
claude.stderr.on('data', (data) => {
  process.stderr.write(`[stderr] ${data}`);
  refreshTimeout(); // stderr ä¹Ÿæ˜¯æ´»è·ƒä¿¡å·ï¼
});
```

**æ•™è®­**:
- CLI å·¥å…·çš„æ€è€ƒè¿‡ç¨‹ã€å·¥å…·è°ƒç”¨ã€è¿›åº¦ä¿¡æ¯é€šå¸¸è¾“å‡ºåˆ° stderr
- è¶…æ—¶æ£€æµ‹å¿…é¡»åŒæ—¶ç›‘å¬ä¸¤ä¸ªæµ
- è¿™æ˜¯ç¬¬äºŒè¯¾ä¸­ç¼…å› çŒ«è¢«æš´åŠ› kill çš„æ ¹æœ¬åŸå› 

---

### å‘ 3: Session ID æ··æ·†å¯¼è‡´"ä¸è®°å¾—"å¯¹è¯

**ç°è±¡**:
```
ğŸ“š Resuming session: 90be7664-4af0-4c75-9b6a-c8d254434399
...
Claude: "ä¸è®°å¾—ï¼Œå› ä¸ºæ¯æ¬¡å¯¹è¯éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæˆ‘ä¸ä¼šä¿ç•™ä¹‹å‰çš„å¯¹è¯å†å²ã€‚"
```

**åŸå› **:
1. ä¹‹å‰æµ‹è¯•ç”¨äº† `--mock` æ¨¡å¼ï¼Œä¿å­˜çš„æ˜¯å‡çš„ session IDï¼ˆ`mock-session-æ—¶é—´æˆ³`ï¼‰
2. æˆ–è€… session ID æ˜¯å¾ˆä¹…ä¹‹å‰è¿è¡ŒçœŸå® CLI ä¿å­˜çš„ï¼Œå·²è¿‡æœŸå¤±æ•ˆ
3. ç”¨ mock session ID å»æ¢å¤çœŸå® CLI çš„ sessionï¼Œå½“ç„¶ä¸è®°å¾—

**ä¿®å¤**:
ä¸éœ€è¦ä¿®å¤ä»£ç ï¼Œéœ€è¦æ­£ç¡®ä½¿ç”¨ï¼š
- é‡ç½® sessionï¼š`node minimal-claude.js --reset "å¼€å§‹æ–°å¯¹è¯"`
- ç”¨çœŸå® CLI è¿è¡Œï¼Œä¸ç”¨ `--mock`
- ç¡®ä¿ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´ session æ²¡æœ‰è¿‡æœŸ

**æ•™è®­**:
- Mock æ¨¡å¼ç”Ÿæˆçš„ session ID ä¸èƒ½ç”¨äºçœŸå® CLI
- Session æœ‰æ—¶æ•ˆæ€§ï¼Œè¿‡æœŸåéœ€è¦é‡æ–°å¼€å§‹
- æµ‹è¯• session åŠŸèƒ½æ—¶ï¼Œç¡®ä¿æ˜¯åŒä¸€ä¸ª CLI å®ä¾‹

---

### å‘ 4: ä¿¡å·å¤„ç†æœªæ•è·æœªå¤„ç†å¼‚å¸¸

**ç°è±¡**:
å¦‚æœä»£ç ä¸­æœ‰æœªæ•è·çš„å¼‚å¸¸æˆ–æœªå¤„ç†çš„ Promise æ‹’ç»ï¼Œè¿›ç¨‹å¯èƒ½å¼‚å¸¸é€€å‡ºï¼Œå­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹ã€‚

**åŸå› **:
åªç›‘å¬äº† `SIGTERM` å’Œ `SIGINT`ï¼Œæ²¡æœ‰ç›‘å¬ `uncaughtException` å’Œ `unhandledRejection`ã€‚

**ä¿®å¤**:
```javascript
// ç›‘å¬æœªæ•è·å¼‚å¸¸
process.on('uncaughtException', (err) => {
  console.error('\nâŒ Uncaught Exception:', err);
  gracefulShutdown();
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('\nâŒ Unhandled Rejection at:', promise, 'reason:', reason);
  gracefulShutdown();
});
```

**æ•™è®­**:
- é™¤äº†æ­£å¸¸çš„ç»ˆæ­¢ä¿¡å·ï¼Œè¿˜è¦å¤„ç†å¼‚å¸¸æƒ…å†µ
- æœªå¤„ç†çš„ Promise æ‹’ç»å’Œæœªæ•è·å¼‚å¸¸éƒ½ä¼šå¯¼è‡´å¼‚å¸¸é€€å‡º
- æ‰€æœ‰é€€å‡ºè·¯å¾„éƒ½åº”è¯¥è§¦å‘æ¸…ç†é€»è¾‘

---

### å‘ 5: ä¸¤é˜¶æ®µå…³æœºæœªç­‰å¾…ç›´æ¥ kill

**ç°è±¡**:
å‘é€ SIGTERM åç«‹å³å‘é€ SIGKILLï¼Œè¿›ç¨‹æ²¡æœ‰æœºä¼šæ¸…ç†èµ„æºã€‚

**åŸå› **:
ä¸¤ä¸ª `setTimeout` åŒæ—¶æ‰§è¡Œï¼Œæ²¡æœ‰ä¸²è¡Œç­‰å¾…ã€‚

**ä¿®å¤**:
```javascript
// âœ… æ­£ç¡®ï¼šå…ˆ SIGTERMï¼Œ5 ç§’åå† SIGKILL
claude.kill('SIGTERM');

setTimeout(() => {
  if (claude && !claude.killed) {
    console.log('ğŸ’¥ Force killing child process...');
    claude.kill('SIGKILL');
  }
  process.exit(0);
}, 5000);
```

**æ•™è®­**:
- ä¸¤é˜¶æ®µå…³æœºçš„å…³é”®æ˜¯ç»™è¿›ç¨‹è¶³å¤Ÿçš„æ¸…ç†æ—¶é—´
- SIGTERM åªæ˜¯è¯·æ±‚é€€å‡ºï¼Œè¿›ç¨‹å¯ä»¥æ‹’ç»æˆ–å¿½ç•¥
- SIGKILL æ˜¯å¼ºåˆ¶æ€æ­»ï¼Œè¿›ç¨‹æ— æ³•å“åº”

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
02-cli-engineering/
â”œâ”€â”€ README.md                  # æœ¬æ–‡ä»¶
â”œâ”€â”€ minimal-claude.js         # å·¥ç¨‹åŒ–åçš„ Claude CLI å°è£…
â”œâ”€â”€ .claude-session.json       # Session æŒä¹…åŒ–ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â””â”€â”€ lessons.md                # å…³é”®æ•™è®­æ€»ç»“
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# å¼€å§‹æ–°å¯¹è¯
cd 02-cli-engineering
node minimal-claude.js --reset "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±"

# ç»§ç»­å¯¹è¯
node minimal-claude.js "ä½ è¿˜è®°å¾—æˆ‘é—®äº†ä»€ä¹ˆå—ï¼Ÿ"
```

### é…ç½®é€‰é¡¹

```bash
# è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 10 åˆ†é’Ÿï¼‰
CLAUDE_TIMEOUT_MS=30000 node minimal-claude.js "30 ç§’è¶…æ—¶æµ‹è¯•"

# è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3 æ¬¡ï¼‰
CLAUDE_MAX_RETRIES=5 node minimal-claude.js "é‡è¯• 5 æ¬¡"

# å¼€å‘ç¯å¢ƒï¼ˆè‡ªåŠ¨ä½¿ç”¨ Redis 6398ï¼‰
NODE_ENV=development node minimal-claude.js "å¼€å‘æµ‹è¯•"

# ç”Ÿäº§ç¯å¢ƒï¼ˆè‡ªåŠ¨ä½¿ç”¨ Redis 6399ï¼‰
NODE_ENV=production node minimal-claude.js "ç”Ÿäº§ä»»åŠ¡"
```

### ç¯å¢ƒéš”ç¦»

```bash
# âš ï¸ å¼€å‘ç¯å¢ƒè¯¯è¿ç”Ÿäº§ Redisï¼ˆä¼šè­¦å‘Šï¼‰
NODE_ENV=development REDIS_PORT=6399 node minimal-claude.js "æµ‹è¯•"

# âœ… æ­£ç¡®çš„å¼€å‘ç¯å¢ƒé…ç½®
NODE_ENV=development REDIS_PORT=6398 node minimal-claude.js "æµ‹è¯•"
```

---

## âœ… åŠŸèƒ½æ¸…å•

- âœ… è°ƒç”¨ Claude CLI å¹¶è§£æ NDJSON æµå¼è¾“å‡º
- âœ… æ”¯æŒ Session æŒä¹…åŒ–å’Œæ¢å¤
- âœ… Mock æ¨¡å¼ï¼ˆç”¨äºæµ‹è¯•ï¼Œæ— éœ€å®‰è£… Claude CLIï¼‰
- âœ… è·¨å¹³å°æ”¯æŒï¼ˆWindows å’Œ Unix-like ç³»ç»Ÿï¼‰
- âœ… è¶…æ—¶æ£€æµ‹ï¼ˆåŒæ—¶ç›‘å¬ stdout å’Œ stderrï¼‰
- âœ… é…ç½®åŒ–è¶…æ—¶æ—¶é—´
- âœ… æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- âœ… ä¸¤é˜¶æ®µä¼˜é›…å…³æœº
- âœ… è¿›ç¨‹ä¿¡å·å¤„ç†ï¼ˆSIGTERM, SIGINT, uncaughtException, unhandledRejectionï¼‰
- âœ… ç¯å¢ƒéš”ç¦»ï¼ˆæ£€æµ‹è¯¯è¿ç”Ÿäº§èµ„æºï¼‰
- âœ… Session é‡ç½®åŠŸèƒ½

---

## ğŸ“Š ä¸ 01 ç‰ˆæœ¬çš„å¯¹æ¯”

| ç‰¹æ€§ | 01-claude-wrapper | 02-cli-engineering |
|------|------------------|-------------------|
| è¶…æ—¶æ£€æµ‹ | âŒ æ—  | âœ… æœ‰ï¼ˆåŒæ—¶ç›‘å¬ stdout/stderrï¼‰ |
| é…ç½®åŒ–è¶…æ—¶ | âŒ ç¡¬ç¼–ç  | âœ… ç¯å¢ƒå˜é‡é…ç½® |
| ä¿¡å·å¤„ç† | âŒ ä»… close | âœ… SIGTERM/SIGINT/å¼‚å¸¸å¤„ç† |
| é‡è¯•æœºåˆ¶ | âŒ æ—  | âœ… æŒ‡æ•°é€€é¿é‡è¯• |
| ç¯å¢ƒéš”ç¦» | âŒ æ—  | âœ… æ£€æµ‹è¯¯è¿ç”Ÿäº§ç¯å¢ƒ |
| ä¼˜é›…å…³æœº | âŒ æ—  | âœ… ä¸¤é˜¶æ®µå…³æœº |
| ç”Ÿäº§å¯ç”¨æ€§ | ğŸ§ª ç©å…·çº§ | âœ… ç”Ÿäº§çº§ |

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. è¶…æ—¶æ£€æµ‹
```javascript
// âœ… åŒæ—¶ç›‘å¬ä¸¤ä¸ªæµ
child.stdout.on('data', refreshTimeout);
child.stderr.on('data', refreshTimeout);
```

### 2. èµ„æºæ¸…ç†
```javascript
// âœ… åœ¨æ‰€æœ‰é€€å‡ºè·¯å¾„æ¸…ç†
try {
  // ... æ‰§è¡Œé€»è¾‘
  cleanup();  // æˆåŠŸæ—¶æ¸…ç†
} catch (err) {
  cleanup();  // å¤±è´¥æ—¶ä¹Ÿè¦æ¸…ç†
  throw err;
}

process.on('exit', cleanup);  // é€€å‡ºæ—¶æ¸…ç†
```

### 3. ç¯å¢ƒéš”ç¦»
```javascript
// âœ… æ£€æµ‹å¹¶è­¦å‘Š
if (NODE_ENV === 'development' && REDIS_PORT === '6399') {
  console.warn('âš ï¸ WARNING: è¯¯è¿ç”Ÿäº§ Redis');
}
```

### 4. ä¼˜é›…å…³æœº
```javascript
// âœ… ä¸¤é˜¶æ®µå…³æœº
child.kill('SIGTERM');
setTimeout(() => {
  if (!child.killed) {
    child.kill('SIGKILL');
  }
}, 5000);
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æ£€æŸ¥æ¸…å•**: [../docs/lessons/02-homework-report.md](../docs/lessons/02-homework-report.md)
- **ä¿®å¤æ€»ç»“**: [../01-claude-wrapper/fixes-summary.md](../01-claude-wrapper/fixes-summary.md)
- **è¯¾ç¨‹æ¥æº**: [ç¬¬äºŒè¯¾ï¼šä»ç©å…·åˆ°ç”Ÿäº§](../docs/lessons/02-cli-engineering.md)

---

## ğŸ“ å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 2026-02-20 | 2.0 | åŸºäº P0-P2 æ£€æŸ¥æ¸…å•è¿›è¡Œå…¨é¢å·¥ç¨‹åŒ–ä¿®å¤ |
| 2026-02-20 | 1.0 | ä» 01-claude-wrapper ç»§æ‰¿å¹¶æ”¹è¿› |

---

*æœ¬é¡¹ç›®åŸºäº cat-cafe-tutorials ç¬¬äºŒè¯¾å†…å®¹è¿›è¡Œå·¥ç¨‹åŒ–å®è·µã€‚*
